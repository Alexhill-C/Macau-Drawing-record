<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>澳門消費券記錄系統</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', 'Microsoft JhengHei', sans-serif;
            font-size: 14px;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 12px;
            overflow-x: auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eaeaea;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 6px;
            font-size: 18px;
        }
        
        .description {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .week-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 12px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .add-platform {
            background: #2ecc71;
        }
        
        .add-platform:hover {
            background: #27ae60;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            table-layout: fixed;
        }
        
        th, td {
            padding: 8px 4px;
            text-align: center;
            border-bottom: 1px solid #eaeaea;
            word-wrap: break-word;
        }
        
        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        
        select, input[type="number"] {
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 100%;
            font-size: 12px;
        }
        
        .required-consumption {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .coupon-used {
            color: #2ecc71;
        }
        
        .coupon-not-used {
            color: #e74c3c;
        }
        
        .delete-btn {
            background: #e74c3c;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .coupon-status {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .coupon-checkbox {
            margin: 0 auto;
            transform: scale(0.8);
        }
        
        @media (max-width: 480px) {
            th, td {
                padding: 6px 2px;
            }
            
            .platform-name {
                min-width: 80px;
            }
            
            .coupon-amount, .consumption, .action {
                min-width: 60px;
            }
        }
        
        .instructions {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
        }
        
        .instructions h3 {
            margin-bottom: 5px;
            color: #2c3e50;
            font-size: 13px;
        }
        
        .instructions ul {
            padding-left: 18px;
        }
        
        .instructions li {
            margin-bottom: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>澳門消費券記錄系統</h1>
            <p class="description">記錄各平台消費券金額及使用情況，每週重新計算</p>
        </header>
        
        <div class="controls">
            <div class="week-selector">
                <label for="week">選擇週數：</label>
                <select id="week">
                    <option value="1">第1週</option>
                    <option value="2">第2週</option>
                    <option value="3">第3週</option>
                    <option value="4">第4週</option>
                </select>
                <button id="reset-btn">重置本週數據</button>
            </div>
            <button id="add-platform-btn" class="add-platform">添加平台</button>
        </div>
        
        <table id="voucher-table">
            <thead>
                <tr>
                    <th class="platform-name">平台</th>
                    <th class="coupon-amount">券1 (MOP)</th>
                    <th class="coupon-amount">已使用</th>
                    <th class="coupon-amount">券2 (MOP)</th>
                    <th class="coupon-amount">已使用</th>
                    <th class="coupon-amount">券3 (MOP)</th>
                    <th class="coupon-amount">已使用</th>
                    <th class="consumption">需消費金額 (MOP)</th>
                    <th class="action">操作</th>
                </tr>
            </thead>
            <tbody>
                <!-- 數據將通過JavaScript動態生成 -->
            </tbody>
        </table>
        
        <div class="instructions">
            <h3>使用說明：</h3>
            <ul>
                <li>每個平台每週只能出現一次</li>
                <li>每張券可以單獨標記已使用</li>
                <li>需消費金額 = 該平台所得券總額 × 3</li>
                <li>每使用10元券，需消費金額自動減少30元</li>
                <li>數據會自動保存到瀏覽器本地</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 支持的平台和券金額
            const platforms = ['MPay', '中銀BOC', '工銀ICBC', '豐付寶', 'Luso國際銀行', '廣發GFB', 'UePay', '支付寶Alipay', 'TFB', 'IGBG'];
            const voucherAmounts = [0, 10, 20, 50, 100, 200];
            
            const tableBody = document.querySelector('#voucher-table tbody');
            const addPlatformBtn = document.getElementById('add-platform-btn');
            const resetBtn = document.getElementById('reset-btn');
            const weekSelector = document.getElementById('week');
            
            // 初始化數據
            let voucherData = JSON.parse(localStorage.getItem('voucherData')) || {};
            let currentWeek = localStorage.getItem('currentWeek') || '1';
            
            // 設置當前週
            weekSelector.value = currentWeek;
            
            // 如果當前週沒有數據，初始化空數據
            if (!voucherData[currentWeek]) {
                voucherData[currentWeek] = [];
                // 添加一些示例數據
                voucherData[currentWeek].push(
                    { 
                        platform: 'Luso國際銀行', 
                        coupons: [0, 0, 0], 
                        used: [true, true, true] 
                    },
                    { 
                        platform: 'IGBG', 
                        coupons: [10, 10, 20], 
                        used: [true, true, true] 
                    },
                    { 
                        platform: '支付寶Alipay', 
                        coupons: [10, 20, 0], 
                        used: [false, false, true] 
                    },
                    { 
                        platform: 'TFB', 
                        coupons: [10, 0, 0], 
                        used: [true, true, true] 
                    },
                    { 
                        platform: 'UePay', 
                        coupons: [10, 10, 0], 
                        used: [true, true, true] 
                    },
                    { 
                        platform: '中銀BOC', 
                        coupons: [20, 20, 10], 
                        used: [false, false, false] 
                    },
                    { 
                        platform: 'MPay', 
                        coupons: [20, 10, 10], 
                        used: [false, false, false] 
                    },
                    { 
                        platform: '廣發GFB', 
                        coupons: [50, 20, 20], 
                        used: [true, true, true] 
                    }
                );
                saveData();
            }
            
            // 渲染表格
            renderTable();
            
            // 添加平台事件監聽
            addPlatformBtn.addEventListener('click', function() {
                const availablePlatforms = platforms.filter(platform => 
                    !voucherData[currentWeek].some(item => item.platform === platform)
                );
                
                if (availablePlatforms.length === 0) {
                    alert('所有平台都已添加！');
                    return;
                }
                
                voucherData[currentWeek].push({
                    platform: availablePlatforms[0],
                    coupons: [0, 0, 0],
                    used: [false, false, false]
                });
                
                saveData();
                renderTable();
            });
            
            // 重置本週數據
            resetBtn.addEventListener('click', function() {
                if (confirm('確定要重置本週的所有數據嗎？此操作不可撤銷。')) {
                    voucherData[currentWeek] = [];
                    saveData();
                    renderTable();
                }
            });
            
            // 週數選擇變化
            weekSelector.addEventListener('change', function() {
                currentWeek = this.value;
                localStorage.setItem('currentWeek', currentWeek);
                
                // 如果選擇的週沒有數據，初始化空數據
                if (!voucherData[currentWeek]) {
                    voucherData[currentWeek] = [];
                    saveData();
                }
                
                renderTable();
            });
            
            // 計算需消費金額
            function calculateRequiredConsumption(coupons, used) {
                let totalCouponValue = 0;
                let usedCouponValue = 0;
                
                for (let i = 0; i < 3; i++) {
                    totalCouponValue += coupons[i];
                    if (used[i]) {
                        usedCouponValue += coupons[i];
                    }
                }
                
                // 需消費金額 = 券總額 × 3 - 已使用券額 × 3
                return (totalCouponValue * 3) - (usedCouponValue * 3);
            }
            
            // 渲染表格函數
            function renderTable() {
                tableBody.innerHTML = '';
                
                voucherData[currentWeek].forEach((item, index) => {
                    const row = document.createElement('tr');
                    
                    // 計算需消費金額
                    const requiredConsumption = calculateRequiredConsumption(item.coupons, item.used);
                    
                    row.innerHTML = `
                        <td>
                            <select class="platform-select" data-index="${index}">
                                ${platforms.map(platform => 
                                    `<option value="${platform}" ${platform === item.platform ? 'selected' : ''}>${platform}</option>`
                                ).join('')}
                            </select>
                        </td>
                        <td>
                            <select class="coupon-select" data-index="${index}" data-coupon="0">
                                ${voucherAmounts.map(amount => 
                                    `<option value="${amount}" ${amount === item.coupons[0] ? 'selected' : ''}>${amount}</option>`
                                ).join('')}
                            </select>
                        </td>
                        <td class="coupon-status">
                            <input type="checkbox" class="coupon-checkbox used-coupon" data-index="${index}" data-coupon="0" ${item.used[0] ? 'checked' : ''}>
                        </td>
                        <td>
                            <select class="coupon-select" data-index="${index}" data-coupon="1">
                                ${voucherAmounts.map(amount => 
                                    `<option value="${amount}" ${amount === item.coupons[1] ? 'selected' : ''}>${amount}</option>`
                                ).join('')}
                            </select>
                        </td>
                        <td class="coupon-status">
                            <input type="checkbox" class="coupon-checkbox used-coupon" data-index="${index}" data-coupon="1" ${item.used[1] ? 'checked' : ''}>
                        </td>
                        <td>
                            <select class="coupon-select" data-index="${index}" data-coupon="2">
                                ${voucherAmounts.map(amount => 
                                    `<option value="${amount}" ${amount === item.coupons[2] ? 'selected' : ''}>${amount}</option>`
                                ).join('')}
                            </select>
                        </td>
                        <td class="coupon-status">
                            <input type="checkbox" class="coupon-checkbox used-coupon" data-index="${index}" data-coupon="2" ${item.used[2] ? 'checked' : ''}>
                        </td>
                        <td class="required-consumption">
                            ${requiredConsumption}
                        </td>
                        <td>
                            <button class="delete-btn" data-index="${index}">刪除</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // 添加事件監聽器
                document.querySelectorAll('.platform-select').forEach(select => {
                    select.addEventListener('change', function() {
                        const index = this.getAttribute('data-index');
                        voucherData[currentWeek][index].platform = this.value;
                        saveData();
                    });
                });
                
                document.querySelectorAll('.coupon-select').forEach(select => {
                    select.addEventListener('change', function() {
                        const index = this.getAttribute('data-index');
                        const couponIndex = this.getAttribute('data-coupon');
                        voucherData[currentWeek][index].coupons[couponIndex] = parseInt(this.value);
                        saveData();
                        renderTable(); // 重新渲染以更新需消費金額
                    });
                });
                
                document.querySelectorAll('.used-coupon').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const index = this.getAttribute('data-index');
                        const couponIndex = this.getAttribute('data-coupon');
                        voucherData[currentWeek][index].used[couponIndex] = this.checked;
                        saveData();
                        renderTable(); // 重新渲染以更新需消費金額
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        if (confirm('確定要刪除這個平台記錄嗎？')) {
                            voucherData[currentWeek].splice(index, 1);
                            saveData();
                            renderTable();
                        }
                    });
                });
            }
            
            // 保存數據到localStorage
            function saveData() {
                localStorage.setItem('voucherData', JSON.stringify(voucherData));
            }
        });
    </script>
</body>
</html>
